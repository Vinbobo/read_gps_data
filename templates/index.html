<!DOCTYPE html>
<html lang="vi">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>D·ªØ li·ªáu ch·∫•m c√¥ng</title>
  <style>
    body { font-family: Arial, sans-serif; background: #f4f6f9; margin: 0; padding: 0; display: flex; flex-direction: column; min-height: 100vh; }
    .container { flex: 1; padding: 20px; }
    h1 { text-align: center; color: #2c3e50; margin: 15px 0; }
    .toolbar { display: flex; justify-content: space-between; align-items: center; margin: 10px 20px; flex-wrap: wrap; }
    .search-box input { padding: 6px; width: 250px; border: 1px solid #ccc; border-radius: 4px; }
    .refresh-btn, .export-btn { padding: 6px 12px; border: none; border-radius: 4px; cursor: pointer; margin-left: 5px; }
    .refresh-btn { background: #27ae60; color: white; }
    .refresh-btn:hover { background: #219150; }
    .export-btn { background: #3498db; color: white; }
    .export-btn:hover { background: #2980b9; }
    .table-container { max-height: 450px; overflow-y: auto; border: 1px solid #ccc; margin: 0 20px; }
    table { width: 100%; border-collapse: collapse; }
    th, td { border: 1px solid #ccc; padding: 8px; text-align: left; }
    th { background: #3498db; color: white; cursor: pointer; position: sticky; top: 0; z-index: 1; }
    tr:nth-child(even) { background: #f9f9f9; }
    .filter-select { padding: 6px; border: 1px solid #ccc; border-radius: 4px; margin-left: 5px; }
  </style>
</head>
<body>
  <h1>Danh s√°ch ch·∫•m c√¥ng</h1>

  <div class="toolbar">
    <div class="search-box">
      <input type="text" id="searchInput" placeholder="üîç T√¨m ki·∫øm theo t√™n ho·∫∑c m√£ NV...">
    </div>
    <div>
      <select id="timeFilter" class="filter-select" onchange="reloadData()">
        <option value="all">T·∫•t c·∫£</option>
        <option value="week">Tu·∫ßn n√†y</option>
        <option value="month">Th√°ng n√†y</option>
        <option value="year">NƒÉm nay</option>
      </select>
      <button class="export-btn" onclick="exportToExcel()">üì• Xu·∫•t Excel</button>
      <button class="refresh-btn" onclick="reloadData()">üîÑ L√†m m·ªõi</button>
    </div>
  </div>

  <div class="table-container">
    <table id="attendanceTable">
      <thead>
        <tr>
          <th onclick="sortTable(0)">M√£ NV</th>
          <th onclick="sortTable(1)">T√™n NV</th>
          <th onclick="sortTable(2)">ƒê·ªãa ch·ªâ</th>
          <th onclick="sortTable(3)">Th·ªùi gian</th>
          <th onclick="sortTable(4)">Status</th>
        </tr>
      </thead>
      <tbody id="attendanceData">
        <!-- D·ªØ li·ªáu s·∫Ω ƒë∆∞·ª£c ch√®n b·∫±ng JavaScript -->
      </tbody>
    </table>
  </div>

  <script>
    let tableData = [];
    let sortDirection = {};

    // Load data with filter
    function reloadData() {
      const filter = document.getElementById('timeFilter').value;
      fetch(`/api/attendances?filter=${filter}`)
        .then(response => response.json())
        .then(data => {
          tableData = data;
          renderTable(tableData);
        })
        .catch(error => console.error('Error:', error));
    }

    // Render d·ªØ li·ªáu ra b·∫£ng
    function renderTable(data) {
      const tbody = document.getElementById('attendanceData');
      tbody.innerHTML = '';
      data.forEach(item => {
        const row = document.createElement('tr');
        row.innerHTML = `
          <td>${item.EmployeeId || ''}</td>
          <td>${item.EmployeeName || ''}</td>
          <td>${item.Address || ''}</td>
          <td>${item.CheckinTime || ''}</td>
          <td>${item.Status || ''}</td>
        `;
        tbody.appendChild(row);
      });
    }

    // T√¨m ki·∫øm theo √¥ input
    document.getElementById('searchInput').addEventListener('keyup', function() {
      const keyword = this.value.toLowerCase();
      const filtered = tableData.filter(item =>
        (item.EmployeeId && item.EmployeeId.toString().toLowerCase().includes(keyword)) ||
        (item.EmployeeName && item.EmployeeName.toLowerCase().includes(keyword))
      );
      renderTable(filtered);
    });

    // S·∫Øp x·∫øp b·∫£ng khi click ti√™u ƒë·ªÅ
    function sortTable(colIndex) {
      const colKeys = ['EmployeeId','EmployeeName','Address','CheckinTime','Status'];
      const key = colKeys[colIndex];
      sortDirection[key] = !sortDirection[key]; // toggle ASC/DESC
    
      tableData.sort((a,b) => {
        let valA = a[key] || '';
        let valB = b[key] || '';
        if (key === 'CheckinTime') {
          valA = new Date(valA);
          valB = new Date(valB);
        }
        if (valA < valB) return sortDirection[key] ? -1 : 1;
        if (valA > valB) return sortDirection[key] ? 1 : -1;
        return 0;
      });
      renderTable(tableData);
    
      // --- th√™m k√Ω hi·ªáu m≈©i t√™n
      const ths = document.querySelectorAll("th");
      ths.forEach((th,i)=> {
        th.textContent = th.textContent.replace(/[\u25B2\u25BC]/g,""); // xo√° icon c≈©
        if (i === colIndex) {
          th.textContent += sortDirection[key] ? " ‚ñ≤" : " ‚ñº";
        }
      });
    }
    // Xu·∫•t Excel v·ªõi filter hi·ªán t·∫°i
    function exportToExcel() {
      const filter = document.getElementById('timeFilter').value;
      fetch(`/api/export-excel?filter=${filter}`, { method: 'GET' })
        .then(response => response.blob())
        .then(blob => {
          const url = window.URL.createObjectURL(blob);
          const a = document.createElement('a');
          a.href = url;
          a.download = 'attendance_data.xlsx';  // Tr√¨nh duy·ªát s·∫Ω h·ªèi "Save As"
          document.body.appendChild(a);
          a.click();
          document.body.removeChild(a);
          window.URL.revokeObjectURL(url);
        })
        .catch(error => console.error('Error exporting:', error));
    }
    // Load ban ƒë·∫ßu
    window.onload = reloadData;
  </script>
</body>
</html>
