<!DOCTYPE html>
<html lang="vi">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>D·ªØ li·ªáu ch·∫•m c√¥ng</title>
  <style>
    body { font-family: Arial, sans-serif; background: #f4f6f9; padding: 20px; }
    h2 { text-align: center; }
    .toolbar { display: flex; justify-content: space-between; margin-bottom: 15px; flex-wrap: wrap; gap: 10px; }
    .search-box { flex: 1; min-width: 200px; }
    .filter-box { display: flex; gap: 10px; align-items: center; flex-wrap: wrap; }
    input, select, button { padding: 6px 10px; font-size: 14px; border-radius: 5px; border: 1px solid #ccc; }
    button { cursor: pointer; background: #007bff; color: #fff; border: none; }
    button:hover { background: #0056b3; }
    table { width: 100%; border-collapse: collapse; background: #fff; box-shadow: 0 2px 4px rgba(0,0,0,0.1); }
    th, td { padding: 10px; text-align: left; border-bottom: 1px solid #ddd; cursor: pointer; }
    th { background: #007bff; color: #fff; user-select: none; }
    tr:hover { background: #f1f1f1; }
    .arrow { margin-left: 5px; font-size: 12px; }
  </style>
</head>
<body>
  <h2>üìå D·ªØ li·ªáu ch·∫•m c√¥ng GPS</h2>

  <div class="toolbar">
    <div class="search-box">
      <input type="text" id="searchInput" placeholder="üîç T√¨m ki·∫øm theo t√™n ho·∫∑c m√£ NV..." onkeyup="searchTable()">
    </div>

    <div class="filter-box">
      <label>T·ª´:</label>
      <input type="date" id="startDate">
      <label>ƒê·∫øn:</label>
      <input type="date" id="endDate">

      <select id="timeFilter">
        <option value="all">T·∫•t c·∫£</option>
        <option value="week">Tu·∫ßn n√†y</option>
        <option value="month">Th√°ng n√†y</option>
        <option value="year">NƒÉm nay</option>
      </select>

      <button onclick="applyDateFilter()">üìÖ L·ªçc</button>
      <button onclick="clearDateFilter()">‚ùå Hu·ª∑ l·ªçc</button>
      <button onclick="resetAll()">üîÑ L√†m m·ªõi</button>
      <button onclick="exportToExcel()">üì• Xu·∫•t Excel</button>
    </div>
  </div>

  <table id="attendanceTable">
    <thead>
      <tr>
        <th data-key="EmployeeId">M√£ NV <span class="arrow"></span></th>
        <th data-key="EmployeeName">T√™n nh√¢n vi√™n <span class="arrow"></span></th>
        <th data-key="Address">ƒê·ªãa ch·ªâ <span class="arrow"></span></th>
        <th data-key="CheckinTime">Th·ªùi gian Check-in <span class="arrow"></span></th>
        <th data-key="Status">Tr·∫°ng th√°i <span class="arrow"></span></th>
      </tr>
    </thead>
    <tbody></tbody>
  </table>

  <script>
    let tableData = [];
    let currentSort = { key: null, order: null }; // order: 'asc' | 'desc' | null

    function renderTable(data) {
      const tbody = document.querySelector('#attendanceTable tbody');
      tbody.innerHTML = '';
      data.forEach(row => {
        const tr = document.createElement('tr');
        tr.innerHTML = `
          <td>${row.EmployeeId || ''}</td>
          <td>${row.EmployeeName || ''}</td>
          <td>${row.Address || ''}</td>
          <td>${row.CheckinTime || ''}</td>
          <td>${row.Status || ''}</td>
        `;
        tbody.appendChild(tr);
      });
    }

    function reloadData() {
      const filter = document.getElementById('timeFilter').value;
      let url = `/api/attendances?filter=${filter}`;

      fetch(url)
        .then(response => response.json())
        .then(data => {
          tableData = data;
          renderTable(tableData);
        })
        .catch(error => console.error('Error:', error));
    }

    function applyDateFilter() {
      const startDate = document.getElementById('startDate').value;
      const endDate = document.getElementById('endDate').value;
      if (!startDate || !endDate) {
        alert("Vui l√≤ng ch·ªçn ƒë·ªß c·∫£ T·ª´ ng√†y v√† ƒê·∫øn ng√†y!");
        return;
      }
      let url = `/api/attendances?startDate=${startDate}&endDate=${endDate}`;
      fetch(url)
        .then(response => response.json())
        .then(data => {
          tableData = data;
          renderTable(tableData);
        })
        .catch(error => console.error('Error:', error));
    }

    function clearDateFilter() {
      document.getElementById('startDate').value = "";
      document.getElementById('endDate').value = "";
      reloadData();
    }

    function resetAll() {
      document.getElementById('searchInput').value = "";
      document.getElementById('startDate').value = "";
      document.getElementById('endDate').value = "";
      document.getElementById('timeFilter').value = "all";
      clearSortIndicators();
      currentSort = { key: null, order: null };
      reloadData();
    }

    function exportToExcel() {
      const filter = document.getElementById('timeFilter').value;
      const startDate = document.getElementById('startDate').value;
      const endDate = document.getElementById('endDate').value;

      let url = `/api/export-excel?filter=${filter}`;
      if (startDate && endDate) {
        url += `&startDate=${startDate}&endDate=${endDate}`;
      }

      fetch(url, { method: 'GET' })
        .then(response => response.blob())
        .then(blob => {
          const url = window.URL.createObjectURL(blob);
          const a = document.createElement('a');
          a.href = url;
          a.download = 'attendance_data.xlsx';
          document.body.appendChild(a);
          a.click();
          document.body.removeChild(a);
          window.URL.revokeObjectURL(url);
        })
        .catch(error => console.error('Error exporting:', error));
    }

    function searchTable() {
      const keyword = document.getElementById('searchInput').value.toLowerCase();
      const filtered = tableData.filter(row =>
        (row.EmployeeId && row.EmployeeId.toString().toLowerCase().includes(keyword)) ||
        (row.EmployeeName && row.EmployeeName.toLowerCase().includes(keyword))
      );
      renderTable(filtered);
    }

    // S·∫Øp x·∫øp theo c·ªôt
    function sortTable(key) {
      if (currentSort.key === key) {
        if (currentSort.order === 'asc') currentSort.order = 'desc';
        else if (currentSort.order === 'desc') currentSort.order = null;
        else currentSort.order = 'asc';
      } else {
        currentSort.key = key;
        currentSort.order = 'asc';
      }

      clearSortIndicators();
      const th = document.querySelector(`th[data-key="${key}"] .arrow`);
      if (currentSort.order === 'asc') th.textContent = "‚¨ÜÔ∏è";
      else if (currentSort.order === 'desc') th.textContent = "‚¨áÔ∏è";
      else th.textContent = "";

      let sortedData = [...tableData];
      if (currentSort.order) {
        sortedData.sort((a, b) => {
          let valA = a[key] || "";
          let valB = b[key] || "";
          if (typeof valA === 'string') valA = valA.toLowerCase();
          if (typeof valB === 'string') valB = valB.toLowerCase();
          if (valA < valB) return currentSort.order === 'asc' ? -1 : 1;
          if (valA > valB) return currentSort.order === 'asc' ? 1 : -1;
          return 0;
        });
      }
      renderTable(sortedData);
    }

    function clearSortIndicators() {
      document.querySelectorAll('.arrow').forEach(span => span.textContent = "");
    }

    // G·∫Øn s·ª± ki·ªán click v√†o header
    document.addEventListener("DOMContentLoaded", () => {
      document.querySelectorAll("th[data-key]").forEach(th => {
        th.addEventListener("click", () => sortTable(th.getAttribute("data-key")));
      });
      reloadData();
    });
  </script>
</body>
</html>
