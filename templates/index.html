<!DOCTYPE html>
<html lang="vi">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>D·ªØ li·ªáu ch·∫•m c√¥ng</title>
  <style>
    body { font-family: Arial, sans-serif; background: #f4f6f9; margin: 0; padding: 0; display: flex; flex-direction: column; min-height: 100vh; }
    .container { flex: 1; padding: 20px; }
    h2 { text-align: center; color: #2c3e50; margin-bottom: 15px; }
    .toolbar { display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px; }
    .search-box input { padding: 5px; width: 250px; }
    .refresh-btn { padding: 6px 12px; background: #27ae60; color: white; border: none; border-radius: 4px; cursor: pointer; }
    .refresh-btn:hover { background: #219150; }

    .table-container { max-height: 400px; overflow-y: auto; border: 1px solid #ccc; }
    table { width: 100%; border-collapse: collapse; }
    th, td { border: 1px solid #ccc; padding: 8px; text-align: left; }
    th { background: #3498db; color: white; cursor: pointer; position: sticky; top: 0; z-index: 1; }
    tr:nth-child(even) { background: #f9f9f9; }
  </style>
</head>
<body>

  <div class="container">
    <h2>Danh s√°ch ch·∫•m c√¥ng</h2>
    <div class="toolbar">
      <div class="search-box">
        <input type="text" id="searchInput" placeholder="T√¨m ki·∫øm...">
      </div>
      <button class="refresh-btn" onclick="refreshData()">üîÑ L√†m m·ªõi</button>
    </div>
    <div class="table-container">
      <table>
        <thead>
          <tr>
            <th onclick="sortTable(0)">M√£ NV</th>
            <th onclick="sortTable(1)">T√™n NV</th>
            <th onclick="sortTable(2)">ƒê·ªãa ch·ªâ</th>
            <th onclick="sortTable(3)">Th·ªùi gian</th>
            <th onclick="sortTable(4)">Status</th>
          </tr>
        </thead>
        <tbody id="data-body"></tbody>
      </table>
    </div>
  </div>

  <footer>
    <p>&copy; 2025 H·ªá th·ªëng ch·∫•m c√¥ng GPS</p>
  </footer>

  <script>
    let attendanceData = [];

    async function loadData() {
      try {
        const res = await fetch("/api/attendances");
        const data = await res.json();
        attendanceData = data;
        renderTable(data);
        console.log("D·ªØ li·ªáu ƒë√£ ƒë∆∞·ª£c l√†m m·ªõi:", new Date().toLocaleTimeString());
      } catch (err) {
        console.error("L·ªói t·∫£i d·ªØ li·ªáu:", err);
      }
    }

    function renderTable(data) {
      const tbody = document.getElementById("data-body");
      tbody.innerHTML = "";
      data.forEach(row => {
        const tr = document.createElement("tr");
        tr.innerHTML = `
          <td>${row.EmployeeId || ""}</td>
          <td>${row.EmployeeName || ""}</td>
          <td>${row.Address || ""}</td>
          <td>${row.CheckinTime ? new Date(row.CheckinTime).toLocaleString() : ""}</td>
          <td>${row.Status || ""}</td>
        `;
        tbody.appendChild(tr);
      });
    }

    // üîé T√¨m ki·∫øm
    document.getElementById("searchInput").addEventListener("keyup", function () {
      const keyword = this.value.toLowerCase();
      const filtered = attendanceData.filter(row =>
        (row.EmployeeId || "").toLowerCase().includes(keyword) ||
        (row.EmployeeName || "").toLowerCase().includes(keyword) ||
        (row.Address || "").toLowerCase().includes(keyword) ||
        (row.Status || "").toLowerCase().includes(keyword)
      );
      renderTable(filtered);
    });

    // ‚ÜïÔ∏è S·∫Øp x·∫øp
    let sortDirection = true;
    function sortTable(colIndex) {
      const keys = ["EmployeeId", "EmployeeName", "Address", "CheckinTime", "Status"];
      const sorted = [...attendanceData].sort((a, b) => {
        let valA = a[keys[colIndex]] || "";
        let valB = b[keys[colIndex]] || "";

        if (keys[colIndex] === "CheckinTime") {
          valA = new Date(valA);
          valB = new Date(valB);
        }

        if (valA < valB) return sortDirection ? -1 : 1;
        if (valA > valB) return sortDirection ? 1 : -1;
        return 0;
      });

      sortDirection = !sortDirection;
      renderTable(sorted);
    }

    // üîÑ N√∫t l√†m m·ªõi
    function refreshData() {
      document.getElementById("searchInput").value = "";
      loadData();
    }

    // üöÄ Auto refresh m·ªói 1 ph√∫t
    setInterval(refreshData, 60000);

    // G·ªçi l·∫ßn ƒë·∫ßu
    loadData();
  </script>
</body>
</html>
