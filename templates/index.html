<!DOCTYPE html>
<html lang="vi">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>D·ªØ li·ªáu ch·∫•m c√¥ng</title>
  <link rel="stylesheet" href="{{ url_for('static', filename='style.css') }}">
  <style>
    table { width: 100%; border-collapse: collapse; margin-top: 20px; }
    th, td { border: 1px solid #ccc; padding: 8px; text-align: left; }
    th { cursor: pointer; background: #f5f5f5; }
    img { max-width: 60px; border-radius: 5px; }
  </style>
</head>
<body>
  <h2>üìã D·ªØ li·ªáu ch·∫•m c√¥ng</h2>

  <div>
    <label>L·ªçc: 
      <select id="filterSelect">
        <option value="">T·∫•t c·∫£</option>
        <option value="week">Tu·∫ßn n√†y</option>
        <option value="month">Th√°ng n√†y</option>
        <option value="year">NƒÉm nay</option>
        <option value="custom">Kho·∫£ng ng√†y</option>
      </select>
    </label>
    <input type="date" id="startDate">
    <input type="date" id="endDate">
    <button onclick="applyDateRange()">L·ªçc</button>
    <input type="text" id="searchInput" placeholder="T√¨m theo t√™n..." oninput="fetchData()">
  </div>

  <table id="checkinTable">
    <thead>
      <tr>
        <th onclick="sortTable('EmployeeId')">M√£ NV</th>
        <th onclick="sortTable('EmployeeName')">T√™n nh√¢n vi√™n</th>
        <th>Ph√≤ng ban</th>
        <th>Ch·ª©c v·ª•</th>
        <th>ƒê·ªãa ch·ªâ</th>
        <th onclick="sortTable('Shift')">Ca</th>
        <th onclick="sortTable('CheckinTime')">Th·ªùi gian</th>
        <th>Tr·∫°ng th√°i</th>
        <th>·∫¢nh</th>
      </tr>
    </thead>
    <tbody></tbody>
  </table>

  <script>
    let currentFilter = "";
    let currentSort = { column: null, order: null };

    async function fetchData() {
      const search = document.getElementById("searchInput").value;
      const startDate = document.getElementById("startDate").value;
      const endDate = document.getElementById("endDate").value;
      let url = `/api/checkins?filter=${currentFilter}&search=${search}`;
      if (currentFilter === "custom" && startDate && endDate) {
        url += `&startDate=${startDate}&endDate=${endDate}`;
      }

      const res = await fetch(url);
      const data = await res.json();
      renderTable(data);
    }

    function applyDateRange() {
      currentFilter = document.getElementById("filterSelect").value;
      fetchData();
    }

    function sortTable(column) {
      if (currentSort.column === column) {
        currentSort.order = currentSort.order === "asc" ? "desc" : (currentSort.order === "desc" ? null : "asc");
      } else {
        currentSort.column = column;
        currentSort.order = "asc";
      }
      fetchData();
    }

    function renderTable(data) {
      if (currentSort.column && currentSort.order) {
        data.sort((a, b) => {
          let valA = a[currentSort.column] || "";
          let valB = b[currentSort.column] || "";

          if (currentSort.column === "CheckinTime") {
            // parse dd/MM/yyyy HH:mm:ss ‚Üí Date
            const parseDate = str => {
              if (!str) return new Date(0);
              const [d, t] = str.split(" ");
              const [day, month, year] = d.split("/");
              return new Date(`${year}-${month}-${day}T${t}`);
            };
            valA = parseDate(valA);
            valB = parseDate(valB);
          }

          if (currentSort.order === "asc") return valA > valB ? 1 : -1;
          if (currentSort.order === "desc") return valA < valB ? 1 : -1;
          return 0;
        });
      }

      const tbody = document.querySelector("#checkinTable tbody");
      tbody.innerHTML = "";
      data.forEach(row => {
        const tr = document.createElement("tr");
        tr.innerHTML = `
          <td>${row.EmployeeId || ""}</td>
          <td>${row.Address || ""}</td>
          <td>${row.Shift || ""}</td>
          <td>${row.CheckinTime || ""}</td>
          <td>${row.Status || ""}</td>
          <td>${row.FaceImage ? `<img src="${row.FaceImage}" />` : ""}</td>
        `;
        tbody.appendChild(tr);
      });
    }

    fetchData();
  </script>
</body>
</html>
